wq/map.js
======

[wq/map.js]

**wq/map.js** is a plugin for [wq/app.js] that adds mapping capabilities.  wq/map.js can leverage the [wq configuration object] to generate [Leaflet] maps for pages rendered via wq/app.js.  The generated maps can automatically download and display GeoJSON data rendered by [wq.db]'s [REST API].

<div data-interactive id='map-example'>
  <div id='doc-map-js-map' style='height:300px;background:#ccc;border:1px solid black'></div>
</div>


## Overview

As a plugin for [wq/app.js], wq/map.js utilizes similar concepts and conventions, with corresponding constraints on how it can be used.  In particular, each map generated by wq/map.js always corresponds to a page defined in the [wq configuration object] with the property `"map"` set to true.  For model-backed pages (`"list": true`), wq/map.js' maps can distinguish between "list" views and "detail" views (though there is currently no equivalent for "edit" views).

wq/map.js leverages three configuration objects:

 * Global *defaults*, such as initial zoom and center.  See `map.init()` below for options.
 * *Map configurations*, which each correspond to a page configuration.  See `map.config.maps[page]` below for options.
 * *Layer configurations*, which describe individual GeoJSON layers in a map configuration.  See `map.addLayerConf()` below for options.

By default, each map will automatically get a single layer configuration pointing to the GeoJSON equivalent of the page:

  * The default layer for a simple page (e.g `/simple`)  will be `/simple.geojson`
  * The default layer for a list page's list view (e.g. `/list`) will be `/list.geojson`
  * The default layer for a list page's detail view (e.g. `/list/itemid`) will be `/list/itemid.geojson`

> For example, the content you are reading is a `Doc` instance with an identifier of `map-js`, rendered in a "detail" view for the `docs` list page.  `docs` is registered in the <a href="http://wq.io/config.json" rel="external">wq configuration for this website</a> as `"map": true`.  Since wq/map.js is loaded for this website, the map at the top of this document should have automatically loaded <a href="http://wq.io/docs/map-js.geojson" rel="external">/docs/map-js.geojson</a> when the page opened.

The default GeoJSON layers should work as long as your webserver is running [wq.db] or a service with a compatible [URL Structure].

## API

`wq/map.js` is typically imported via [AMD] as `map`, though any local variable name can be used.

```javascript
// myapp.js
define(['leaflet', 'wq/app', 'wq/map', ...], function(L, app, map, ...) {
    app.init(...);
    map.init(...);
}
```

The map module provides the following methods and properties.

### `map.init()`

`map.init()` is the primary function for wq/map.js.  `map.init()` registers callback events (via [pages.addRoute()]) that render maps on demand when map-capable pages are shown.  Such pages should be defined with `"map": true` in the [wq configuration object].  Since this configuration is necessary for proper function, wq/map.js should be initialized after wq/app.js as shown in the example above.

`map.init()` accepts an additional configuration object that defines default settings for rendered maps including initial location and zoom.

name | default | purpose
-----|---------|---------
`zoom` | `0` | Default zoom for initially rendered map
`center` | `[0,0]` | Default center (latitude, longitude) for initially rendered map
`autoZoom` | Object | By default, rendered maps will automatically zoom (and pan) to the extent of their embedded GeoJSON feature layers using the following options.  To disable auto-zooming entirely, set `autoZoom` to `false`.
`autoZoom.animate` | `true` | Whether to animate the auto-zooming.  Incorporating animation is valuable as it gives the user a chance to visually orient the rendered features in relation to the original zoom level.
`autoZoom.wait` | `0.5` | How long to wait before triggering auto-zooming, in seconds.  Waiting gives the map a chance to settle and makes the animation more salient.
`autoZoom.sticky` | `true` | Whether to save the last zoom and center (from auto-zooming and/or regular panning) for use in the next map (`true`) or to always start out new maps from the default zoom and center (`false`).  Particularly useful in maintaining visual consistency for the user when they are quickly navigating between a series of list or detail pages in succession.
`autoZoom.maxZoom` | `13` | The maximum zoom level to use when auto-zooming.  (Useful to avoid zooming in to far when the only feature is a single point)
`icon` | Object | Default icon settings for use with `map.createIcon()`.  The "default" default icon settings correspond to the default icon created by Leaflet (`L.Icon.Default`).

By convention, the map defaults configuration is put as a section on the [wq/app.js config object] though it is not actually used by wq/app.js.

#### Example

```javascript
// config.js
define(['db/config'], function(config) {

// (set template defaults, transitions, store)
// ...

// set map config defaults
config.map = {
    'center': [45, -93.25],
    'zoom': 8
}

return config;
});
```

```javascript
// myapp.js
define(['wq/app', 'wq/map', './config', './templates'],
function(app, map, config, templates) {

app.init(config, templates);
map.init(config.map);

});
```

### `map.config.maps[page]`

After initialization, `map.config.maps` will be populated with map configurations for each page in the [wq configuration object] with `"map": true`.  Each map config is directly derived from the equivalent page config and reuses the `url` and `list` settings.  The following extra attributes are defined for maps:

name | default | purpose
-----|---------|---------
`autoLayers` | `true` | If `true`, the maps created for the page will automatically include a default layer as discussed above, as well as any explicitly defined layers.  Set to `false` to only include layers explicitly added via `addLayerConf()`.
`autoZoom` | global setting | Set to `false` to disable autozooming on a per-map basis.
`onshow` | none | Function to call after map is created with `map.createMap()`.  The function will be passed the newly created `L.Map` object.
`div` | `[page]-map` | The id of the `<div>` tag to place the Leaflet map into.  The div should be present in the template in order for the automatic map creation to work.  When using the defaults, the id of each div should be `[page]-map` for list views, and `[page]-[itemid]-map` for detail views.

Like all Leaflet maps, the height of the div should be explicitly specified in an attribute or in CSS.

#### Example

```css
/* main.css */
.my-map-class {
  border: 1px solid black;
  height: 300px;
}
```

```xml
<!-- model_list.html -->
<div id="model-map" class="my-map-class"></div>
```

```xml
<!-- model_detail.html -->
<div id="model-{{id}}-map" class="my-map-class"></div>
```

### `map.addLayerConf()`

`map.addLayerConf()` takes the name of an existing map and a layer configuration to add to it.  `addLayerConf()` is primarily useful for adding boundary layers to list views, or for configuring simple (non-list) pages that don't have a default layer.  The default layer configuration for a list view is its corresponding `[list_url].geojson`, while a detail view will automatically get a corresponding `[list_url]/[id].geojson`.

A layer configuration consists of the following options:

name | purpose
-----|---------
`name` | The name of the layer to show in the layer list
`url` | The path to a geojson file to download (minus the `.geojson` extension)
`style` | A function to define styles based on the properties of each feature in the GeoJSON.  The function should take a feature and return a style object.  Available style options are listed in the documentation for [L.Path].  Equivalent to `L.GeoJSON`'s [style] option.
`oneach` | A function to call for each feature in the GeoJSON.  The function should take a Leaflet layer object and a GeoJSON feature.  `map.renderPopup()` can automatically create a compatible function that will attach a templated popup to each layer using the properties in the GeoJSON feature.  Equivalent to `L.GeoJSON`'s [onEachFeature] option.
`icon` | The name of an icon to use, or a function returning an icon name.  If a function, it will be called with the `feature.properties` for each feature in the dataset.  Icons should first be registered via `map.createIcon()`.
`cluster` | Boolean indicating whether or not to cluster markers.  The default for auto-generated layers is `true` as long as the Leaflet.markercluster plugin is present.  A copy of the plugin is included with wq.app but is not imported by default.
`clusterIcon` | Custom function to use to create cluster icons.  Equivalent to `L.MarkerClusterGroup`'s [iconCreateFunction].

#### Example

```javascript
define(['leaflet', 'wq/map', 'leaflet.markercluster'],

// Don't need a reference for markercluster, just need it to be imported somewhere
function(L, map) {

// app.config.pages = {'mainmap': {'url': 'map', 'list': false, 'map': true}} 
map.addLayerConf('mainmap', {
    'name': "Items",
    'url': "items", //i.e. /items.geojson
    'cluster': true,
    'oneach': map.renderPopup('item')
})

```

### `map.createIcon(name, options)`

`map.createIcon` defines and names an [L.Icon] for later use in layer configurations.  The function accepts a string name and an object containing options for the icon.  Options are the same as those for [L.Icon], but with a number of built-in defaults.  These defaults are optimized to make it trivial to define icons that have the same dimensions and shadow as Leaflet's default icon:

name | default
-----|---------
`iconSize` | `[25, 41]`
`iconAnchor` | `[12, 41]`
`popupAnchor` | `[1, -34]`
`shadowSize` | `[41, 41]`
`shadowUrl` | `L.Icon.Default.imagePath + '/marker-shadow.png'`

#### Example

```javascript
map.createIcon("green", {'iconUrl': "/images/green.png"});
```

### `map.createMap(page, [itemid], [override])`

`map.createMap()` does the actual work of generating a map based on the existing configuration.  If `map.init()` is used, `map.createMap()` will be called automatically whenever map-capable pages are shown.

`map.createMap()` takes up to three arguments:

name | purpose
-----|---------
`page` | The name of the page/map configuration to create a map for.
`itemid` | The id of an individual item in a list (only applies to detail views).
`override` | A mapping of layer configuration options to override on a per layer basis.  The keys should be layer names and the values should be options to override.

### `map.createBaseMaps()`

`map.createBaseMaps()` defines the default basemaps for use in every map generated by wq/map.js.  The function returns an object where the keys are layer names and the values are layer objects (usually `L.TileLayer`).  The basemaps will show up in the layer control generated for each map.  The default implementation returns a `Street` and an `Aerial` layer, drawing from the [MapQuest-OSM and MapQuest Open Aerial] tiles, respectively.  To define custom basemaps for use in your application, simply overwrite `map.createBaseMaps()` with your own definition.

`map.createBaseMaps()` can be used independently of `map.createMap()`, for example if you have a custom Leaflet map not otherwise leveraging wq/map.js but want to reuse the `Street` and/or `Aerial` basemaps.

#### Example
```javascript
define(['leaflet', 'wq/map'], function(L, map) {

// Define custom basemap for use by all wq/map.js maps
map.createBaseMaps = function() {
    return {
        "Street": L.tileLayer("http://my-tile-server.com/tiles/{z}/{x}/{y}.png")
    }
}

// And/or use a basemap in a custom map
var layer = map.createBaseMaps().Street

var customMap = L.map(...);
layer.addTo(customMap);

});
```

### `map.getLayerConfs(page, itemid)`

`map.getLayerConfs()` returns a list of layer configurations appropriate for the given page (and item for detail views).  The default implementation returns any manually defined layers as well as an automatic layer for list and detail views (unless `autoLayers` is set to `false`, in which case only the manually defined layers are returned).  You can override this function if you would like to change the automatic layer creation algorithm.  See `map.addLayerConf()` above for the layer configuration syntax.

### `map.createLayerControl(basemaps, layers)`

`map.createLayerControl()` is a simple hook to allow customization of the default layer control added to every map generated by wq/map.js.  The function takes two arguments; the basemaps from `map.createBaseMaps()`, and the GeoJSON layers created by `map.createMap()` (using information from `map.getLayerConfs()`).  The default implementation simply passes the arguments on to, and returns, a [L.Control.Layers] instance.

### `map.renderPopup(page)`

`map.renderPopup(page)` generates a callback function suitable for use as the `oneach` argument to a layer configuration, or as the [onEachFeature] option in `L.GeoJSON`.  The function will automatically render a popup using the template with the name `[page]_popup`, which should be included among the templates provided to [wq/app.js]' `init()` function.  The template context will be the GeoJSON properties on each feature.  The example map at the top of the page uses the following template:

```xml
<!-- doc_popup.html -->
<h3>{{label}}</h3>
<table>
  <tr><th>Chapter:</th><td>{{chapter_label}}</td></tr>
  <tr><th>Last Updated:</th><td>{{updated_label}}</td></tr>
  <tr>
    <th>Interactive:</th>
    <td>
      {{#interactive}}&check;{{/interactive}}
      {{^interactive}}&cross;{{/interactive}}
    </td>
  </tr>
</table>
```

### `map.loadLayer(url, callback)`

`map.loadLayer()` is what `map.createMap()` calls to actually retrieve the GeoJSON data for each layer configuration.  The default implementation caches each GeoJSON object, so you can call `map.loadLayer()` to prefetch layers that you expect to appear in later maps.  The `url` argument is assumed to be relative to the webservice root used by [wq/store.js].

[wq/map.js]: https://github.com/wq/wq.app/blob/master/js/wq/map.js
[wq configuration object]: http://wq.io/docs/config
[Leaflet]: http://leafletjs.com
[wq.db]: http://wq.io/wq.db
[REST API]: http://wq.io/docs/about-rest
[wq/app.js]: http://wq.io/docs/app-js
[AMD]: http://wq.io/docs/amd
[pages.addRoute()]: http://wq.io/docs/pages-js
[wq/app.js config object]: http://wq.io/docs/app-js
[URL Structure]: http://wq.io/docs/url-structure
[L.Path]: http://leafletjs.com/reference.html#path
[style]: http://leafletjs.com/reference.html#geojson-style
[onEachFeature]: http://leafletjs.com/reference.html#geojson-oneachfeature
[iconCreateFunction]: https://github.com/Leaflet/Leaflet.markercluster#customising-the-clustered-markers
[L.Icon]: http://leafletjs.com/reference.html#icon
[MapQuest-OSM and MapQuest Open Aerial]: http://developer.mapquest.com/web/products/open/map
[L.Control.Layers]: http://leafletjs.com/reference.html#control-layers
[wq/store.js]: http://wq.io/docs/store-js
